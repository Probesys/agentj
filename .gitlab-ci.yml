---

# -*- coding: utf-8 -*-
image: docker:latest

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_IMAGE_TAG: $CI_PIPELINE_ID

services:
  - docker:dind

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - vendor/

stages:
  - build
  - deploy

before_script:
  - docker login --username $HUB_USER -p $HUB_TOKEN
  - |-
        if [[ ! -z $CI_COMMIT_TAG ]] ; then
            TAG=$CI_COMMIT_TAG
        elif [[ $CI_COMMIT_BRANCH == "master" ]] ; then
            TAG="latest"
        else
            TAG=$CI_COMMIT_BRANCH
        fi
        echo $TAG

app_build:
  stage: build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - vendor/
  variables:
    IMG: app
  script:
    - apk add --no-cache nodejs yarn composer php7
    - docker pull $REGISTRY/agentj_$IMG:$TAG || true
    - cd $CI_PROJECT_DIR/$IMG && docker build --cache-from $REGISTRY/agentj_$IMG:$TAG -t $REGISTRY/agentj_$IMG:$TAG .
    - docker push $REGISTRY/agentj_$IMG:$TAG
#  only:
#    changes:
#      - app/*
#      - app/**/*

amavis_build:
  stage: build
  variables:
    IMG: amavis
  script:
    - docker pull $REGISTRY/agentj_amavis || true
    - cd $CI_PROJECT_DIR/$IMG && docker build --cache-from $REGISTRY/agentj_$IMG:$TAG -t $REGISTRY/agentj_$IMG:$TAG .
    - docker push $REGISTRY/agentj_$IMG:$TAG
#  only:
#    changes:
#      - amavis/*
#      - amavis/**/*

relay_build:
  stage: build
  variables:
    IMG: relay
  script:
    - docker pull $REGISTRY/agentj_relay || true
    - cd $CI_PROJECT_DIR/$IMG && docker build --cache-from $REGISTRY/agentj_$IMG:$TAG -t $REGISTRY/agentj_$IMG:$TAG .
    - docker push $REGISTRY/agentj_$IMG:$TAG
#  only:
#    changes:
#      - relay/*
#      - relay/**/*

smtp_build:
  stage: build
  variables:
    IMG: smtp
  script:
    - docker pull $REGISTRY/agentj_smtp || true
    - cd $CI_PROJECT_DIR/$IMG && docker build --cache-from $REGISTRY/agentj_$IMG:$TAG -t $REGISTRY/agentj_$IMG:$TAG .
    - docker push $REGISTRY/agentj_$IMG:$TAG
#  only:
#    changes:
#      - smtp/*
#      - smtp/**/*

syslogng_build:
  stage: build
  variables:
    IMG: syslogng
  script:
    - docker pull $REGISTRY/agentj_syslogng || true
    - cd $CI_PROJECT_DIR/$IMG && docker build --cache-from $REGISTRY/agentj_$IMG:$TAG -t $REGISTRY/agentj_$IMG:$TAG .
    - docker push $REGISTRY/agentj_$IMG:$TAG
#  only:
#    changes:
#      - syslogng/*
#      - syslogng/**/*

web_build:
  stage: build
  variables:
    IMG: web
  script:
    - docker pull $REGISTRY/agentj_web || true
    - cd $CI_PROJECT_DIR/$IMG && docker build --cache-from $REGISTRY/agentj_$IMG:$TAG -t $REGISTRY/agentj_$IMG:$TAG .
    - docker push $REGISTRY/agentj_$IMG:$TAG
#  only:
#    changes:
#      - web/*
#      - web/**/*

deploy-dev:
  stage: deploy
  cache: {}
  environment:
    name: dev
  variables:
    DEPLOY_USER: docker
    DEPLOY_DIR: "/home/$DEPLOY_USER/agentj-docker"
  before_script:
    - apk add --no-cache rsync
    - |-
          if [[ ! -z $CI_COMMIT_TAG ]] ; then
              TAG=$CI_COMMIT_TAG
          elif [[ $CI_COMMIT_BRANCH == "master" ]] ; then
              TAG="latest"
          else
              TAG=$CI_COMMIT_BRANCH
          fi
          echo $TAG
  script:
    - mkdir ~/.ssh && ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts && chmod 700 ~/.ssh
    - echo "$SSH_CONFIG" > ~/.ssh/config && chmod 400 ~/.ssh/config
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa && chmod 400 ~/.ssh/id_rsa
    - export DOCKER_HOST="ssh://${DEPLOY_USER:-$USER}@${DEPLOY_HOST:-$1}"
    - sed -i "s/latest/$TAG/g" docker-compose.yml
    - echo $DEPLOY_DIR
    - ssh $DEPLOY_USER@$DEPLOY_HOST -C "[ ! -d $DEPLOY_DIR ] && mkdir -p $DEPLOY_DIR || true"
    - rsync -arv --exclude=".env" ./ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_DIR/
    - ssh $DEPLOY_USER@$DEPLOY_HOST -C "cd $DEPLOY_DIR/ && docker-compose down"
    - docker image rm $(docker image ls -q -f reference=*/*agentj_*) || true
    - docker volume rm agentj-docker_public || true
    - ssh $DEPLOY_USER@$DEPLOY_HOST -C "cd $DEPLOY_DIR/ && docker-compose up -d"
  except:
    - merge_requests
    - master
