---

# -*- coding: utf-8 -*-
image: docker:latest

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:dind

stages:
  - build

################################################################################
## BUILD AND PUSH
################################################################################
# Images build are pushed on hub.probesys.com

app_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/app && docker build -t hub.probesys.com/agentj_app .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_app:latest
  only:
    refs:
      - master
    changes:
      - app/*
      - app/**/*

amavis_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/amavis && docker build -t hub.probesys.com/agentj_amavis .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_amavis:latest
  only:
    refs:
      - master
    changes:
      - amavis/*
      - amavis/**/*

opendkim_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/opendkim && docker build -t hub.probesys.com/agentj_opendkim .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_opendkim:latest
  only:
    refs:
      - master
    changes:
      - opendkim/*
      - opendkim/**/*

relay_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/relay && docker build -t hub.probesys.com/agentj_relay .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_relay:latest
  only:
    refs:
      - master
    changes:
      - relay/*
      - relay/**/*

smtp_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/smtp && docker build -t hub.probesys.com/agentj_smtp .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_smtp:latest
  only:
    refs:
      - master
    changes:
      - smtp/*
      - smtp/**/*

syslogng_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/syslogng && docker build -t hub.probesys.com/agentj_syslogng .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_syslogng:latest
  only:
    refs:
      - master
    changes:
      - syslogng/*
      - syslogng/**/*

web_build:
  stage: build
  script:
   - cd $CI_PROJECT_DIR/web && docker build -t hub.probesys.com/agentj_web .
   - echo "$P6HUB_PASSWORD" | docker login -u "$P6HUB_USER" --password-stdin hub.probesys.com
   - docker push hub.probesys.com/agentj_web:latest
  only:
    refs:
      - master
    changes:
      - web/*
      - web/**/*
